# Wildberries Parser

Асинхронный парсер товаров с Wildberries. Собирает карточки товаров по поисковому запросу, извлекает характеристики, цены, остатки, ссылки на фото и информацию о продавце — и сохраняет всё в Excel.

---

## Что делает парсер

1. Ищет товары по запросу через внутренний API Wildberries
2. Для каждого товара запрашивает детальную карточку (цена, рейтинг, размеры, остатки)
3. Дополнительно забирает описание, характеристики и ссылки на фото с CDN
4. Сохраняет сырые данные построчно в `res.json`
5. На выходе генерирует два Excel-файла:
   - `full_catalog.xlsx` — полный список найденных товаров
   - `russia_top_selection.xlsx` — отфильтрованная выборка (рейтинг ≥ 4.5, цена ≤ 10 000 ₽, производство Россия)

---

## Установка

```bash
uv sync
```

---

## Использование

Открыть `main()` и изменить поисковый запрос:

```python
query = "пальто из натуральной шерсти"  # ← сюда свой запрос
```

Запуск:

```bash
python parser.py
```

Если прервать через `Ctrl+C`, будет предложено сохранить уже собранные данные в Excel.

---

## Структура выходных данных

| Поле | Описание |
|---|---|
| Артикул | ID товара на WB |
| Ссылка на товар | Прямая ссылка на карточку |
| Название | Название товара |
| Цена | Цена в рублях |
| Описание | Текстовое описание из карточки |
| Характеристики | Список характеристик (материал, страна и пр.) |
| Ссылки на изображения | Прямые ссылки на фото через CDN, через запятую |
| Продавец | Название продавца |
| Ссылка на продавца | Страница бренда на WB |
| Размеры | Доступные размеры через запятую |
| Остатки | Суммарное количество на складах |
| Рейтинг | Средняя оценка товара |
| Количество отзывов | Число отзывов |

---

## Определение баскетов (basket_mapper.py)

Wildberries хранит медиафайлы и карточки товаров на CDN-серверах — `basket-01`, `basket-02`, ... `basket-38`. Информация о том, какой артикул лежит на каком баскете, нигде публично не документирована, поэтому её нужно определять эмпирически.

`basket_mapper.py` запускается **отдельно, один раз**, перед основным парсером. Он строит карту соответствия `vol → basket` и сохраняет её в `basket_map.json`, которую затем использует основной парсер.

**Порядок действий:**

1. Сначала нужно сформировать файл `res.csv` со всеми артикулами, которые планируется парсить. Формат — по одному артикулу на строку, артикул первым полем:
   ```
   123456789,...
   987654321,...
   ```

2. Запустить маппер:
   ```bash
   python basket_mapper.py
   ```

3. После завершения появится файл `basket_map.json`. Только после этого можно запускать основной парсер.

Маппер работает через бинарный поиск по диапазонам `vol` (артикул // 100_000), что позволяет найти границы каждого баскета за минимальное количество запросов вместо линейного перебора.

---

## Технические детали

- Конкурентность ограничена `Semaphore(5)` — не более 5 одновременных запросов
- При ошибке `429 Too Many Requests` парсер делает паузу и повторяет запрос
- Для устойчивости к `ConnectionTimeoutError` используется `tenacity` (5 попыток с интервалом 5 сек)
- Данные пишутся в `res.json` построчно (NDJSON), что позволяет восстановить частичный результат при падении

---

## Важно

Парсер использует внутренние API Wildberries и Cookie-авторизацию. Cookie хранится в переменной `HEADERS` и **имеет ограниченный срок жизни** — при ошибках авторизации его нужно обновить вручную.

Чтобы получить свои куки:
1. Открыть [wildberries.ru](https://www.wildberries.ru) в браузере и авторизоваться
2. Открыть DevTools → вкладка **Network**
3. Обновить страницу, найти любой запрос к `wildberries.ru`
4. В заголовках запроса скопировать значение `Cookie`
5. Вставить его в `HEADERS` в начале файла:

```python
HEADERS = {"Cookie": "ВАШ_COOKIE"}
```